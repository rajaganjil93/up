#!/bin/bash
# Add UDP ZiVPN User + Expiry + IP Limit

CONF="/etc/zivpn/config.json"
DB="/etc/zivpn/users.db"
domain=$(cat /etc/xray/domain)
LIMIT="2"
TRIAL_MINUTES="60"

clear
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "     TRIAL UDP ZIVPN PRO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Generate random username & password
USER="trial$(tr -dc a-z0-9 </dev/urandom | head -c4)"
PASS="$(tr -dc a-z0-9 </dev/urandom | head -c6)"

# Cek user sudah ada
grep -q "\"$PASS\"" "$CONF" && {
  echo "âš ï¸ User sudah ada"
  exit 1
}

# Expired dalam menit (format datetime penuh)
EXP=$(date -d "+$TRIAL_MINUTES minutes" +"%Y-%m-%d %H:%M:%S")

# Tambah user ke config.json
sed -i "s/\"config\": \[/\"config\": [\"$PASS\", /" "$CONF"

# Simpan ke database
# format: user|expired|limit|locked
echo "$PASS|$EXP_DATE|$LIMIT|0" >> "$DB"

systemctl restart zivpn

echo ""
echo "âœ… TRIAL UDP ZIVPN DIBUAT"
echo "ğŸŒ Host     : $domain"
echo "ğŸ‘¤ Username : $USER"
echo "ğŸ” Password : $PASS"
echo "ğŸ“† Expired  : $EXP"
echo "â±ï¸ Durasi   : $TRIAL_MINUTES Menit"
echo "ğŸ”’ Limit IP : $LIMIT"
echo ""
